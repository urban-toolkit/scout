<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Load Route from JSON</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
      body {
        font-family: sans-serif;
      }
      #map {
        width: 1600px;
        height: 1000px;
        border: 1px solid black;
      }
      button {
        font-size: 1.2em;
        padding: 10px;
        margin-bottom: 10px;
      }
      #info {
        margin-bottom: 10px;
        font-size: 1.1em;
      }
    </style>
  </head>
  <body>
    <h1>Dynamic Route Loader</h1>
    <div id="info">
      Click on the map to set Origin (1st click) and Destination (2nd click)
    </div>
    <button id="loadRouteBtn">Load Calculated Route</button>
    <button id="clearMarkersBtn">Clear Markers</button>
    <div id="map"></div>

    <script>
      var map = L.map("map").setView([41.88, -87.64], 14);
      let currentRouteLayer = null;

      // Store markers
      let originMarker = null;
      let destinationMarker = null;

      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      }).addTo(map);

      const loadRouteButton = document.getElementById("loadRouteBtn");
      const clearMarkersButton = document.getElementById("clearMarkersBtn");

      // Handle map clicks to place markers
      function onMapClick(e) {
        if (!originMarker) {
          // First click - set origin
          originMarker = L.marker(e.latlng, {
            icon: L.icon({
              iconUrl:
                "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
              shadowUrl:
                "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41],
            }),
          })
            .addTo(map)
            .bindPopup("<b>Origin</b>")
            .openPopup();

          document.getElementById(
            "info"
          ).textContent = `Origin: ${e.latlng.lat.toFixed(
            6
          )}, ${e.latlng.lng.toFixed(6)} - Click again to set Destination`;
        } else if (!destinationMarker) {
          // Second click - set destination
          destinationMarker = L.marker(e.latlng, {
            icon: L.icon({
              iconUrl:
                "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
              shadowUrl:
                "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41],
            }),
          })
            .addTo(map)
            .bindPopup("<b>Destination</b>")
            .openPopup();

          document.getElementById("info").textContent =
            `Origin: ${originMarker.getLatLng().lat.toFixed(6)}, ${originMarker
              .getLatLng()
              .lng.toFixed(6)} | ` +
            `Destination: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(
              6
            )} - Ready to load route!`;
        } else {
          // Already have both markers - reset and start over
          map.removeLayer(originMarker);
          map.removeLayer(destinationMarker);
          originMarker = null;
          destinationMarker = null;

          // Set new origin
          originMarker = L.marker(e.latlng, {
            icon: L.icon({
              iconUrl:
                "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
              shadowUrl:
                "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41],
            }),
          })
            .addTo(map)
            .bindPopup("<b>Origin</b>")
            .openPopup();

          document.getElementById(
            "info"
          ).textContent = `Origin: ${e.latlng.lat.toFixed(
            6
          )}, ${e.latlng.lng.toFixed(6)} - Click again to set Destination`;
        }
      }

      map.on("click", onMapClick);

      // Clear markers button
      clearMarkersButton.addEventListener("click", () => {
        if (originMarker) {
          map.removeLayer(originMarker);
          originMarker = null;
        }
        if (destinationMarker) {
          map.removeLayer(destinationMarker);
          destinationMarker = null;
        }
        document.getElementById("info").textContent =
          "Click on the map to set Origin (1st click) and Destination (2nd click)";
      });

      loadRouteButton.addEventListener("click", () => {
        // Check if both markers are set
        if (!originMarker || !destinationMarker) {
          alert(
            "Please set both Origin and Destination markers on the map first!"
          );
          return;
        }

        const origin = originMarker.getLatLng();
        const destination = destinationMarker.getLatLng();

        const dataToSend = {
          city: "chicago",
          origin: [origin.lat, origin.lng],
          destination: [destination.lat, destination.lng],
          bbox: [41.895, 41.875, -87.62, -87.645],
          map_view_mode: "Maps",
          paths: 3,
          weather: ["rain", "heat"],
          weights: [0.85834, 0.13],
          time: 17,
        };

        console.log("Sending data:", dataToSend);

        fetch("http://127.0.0.1:5000/weather", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(dataToSend),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok.");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Received data:", data);
            const routes = data.route_coords;
            console.log("Routes array:", routes);
            plotRoutes(routes);
          })
          .catch((error) => {
            console.error("Error loading route:", error);
            alert("Error loading route. Check console.");
          });
      });

      // ---------------------------------------------------------
      // Plot multiple routes (each route has coordinates array)
      // ---------------------------------------------------------
      function plotRoutes(routes) {
        if (currentRouteLayer) {
          map.removeLayer(currentRouteLayer);
        }

        let layers = [];
        let allLatLngs = [];

        routes.forEach((route) => {
          // Convert coord format: backend gives [lat, lon]
          const latlngs = route.coordinates.map((c) => [c[0], c[1]]);

          allLatLngs.push(...latlngs);

          // Draw polyline
          const line = L.polyline(latlngs, {
            color: getColor(route.weight_type),
            weight: 5,
            opacity: 0.9,
          }).bindPopup(
            `<b>Route ${route.route_index}</b><br>Weight: ${route.weight_type}`
          );

          // Don't add start/end markers since we already have origin/destination markers
          layers.push(line);
        });

        currentRouteLayer = L.layerGroup(layers).addTo(map);

        if (allLatLngs.length > 0) {
          map.fitBounds(allLatLngs);
        }
      }

      // Color per weight_type
      function getColor(type) {
        const colors = {
          rain: "blue",
          heat: "red",
          wind: "purple",
          humidity: "green",
          quickest_path: "black",
          total_weight: "orange",
        };
        return colors[type] || "gray";
      }
    </script>
  </body>
</html>
